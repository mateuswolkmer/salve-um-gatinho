---
import Layout from '../layouts/Layout.astro';
import { AdoptForm } from '../components/pages/Cat/AdoptForm';
import { formatRelative, formatDistanceToNow } from 'date-fns'
import { ptBR } from 'date-fns/locale'
import PageSection from '../components/PageSection.astro';
import { CatsList } from '../components/CatsList';
import { CatTags } from '../components/CatTags';
import type { Cat } from '../../tina/__generated__/types';
import { getAllCats } from '../api/cats';

const cats = await getAllCats();

// TODO remove when SSR
export async function getStaticPaths() {
  // FIXME double call
  const cats = await getAllCats();

  return cats?.map((cat) => ({
    params: { slug: cat.slug },
    props: { cat }
  }))
}

export type Props = {
  cat: Cat;
}

const { slug } = Astro.params;
const { cat } = Astro.props;
const { name, image, description, birthDate: unformattedBirthDate, rescueDate: unformattedRescueDate, neutered, vaccinated, gender, patronized, social, playful, loving } = cat;

const bornAtTheShelter = unformattedBirthDate === unformattedRescueDate;

const today = new Date();
const birthDate = unformattedBirthDate && formatRelative(unformattedBirthDate, today, { locale: ptBR });
const rescueDate = unformattedRescueDate && formatRelative(unformattedRescueDate, today, { locale: ptBR });
const birthDateDistance = unformattedBirthDate && formatDistanceToNow(unformattedBirthDate, { locale: ptBR, addSuffix: true });
const rescueDateDistance = unformattedRescueDate && formatDistanceToNow(unformattedRescueDate, { locale: ptBR, addSuffix: true });

const article = gender === 'female' ? 'a' : 'o';

let status: string;
if(neutered && vaccinated) {
  status = `Estou castrad${article} e vacinad${article}`
} else if (neutered && !vaccinated) {
  status = `Estou castrad${article}, mas n√£o vacinad${article}`
} else if (!neutered && vaccinated) {
  status = `Estou vacinad${article}, mas n√£o castrad${article}`
} else {
  status = `N√£o estou castrad${article} nem vacinad${article}`
}

// will only work when SSR
const startOpened = Boolean(Astro.url.searchParams.get('adotar')) || false;

---
<Layout title="Adote">
    <PageSection>
      <div class="flex flex-col gap-24">
        <div class="flex flex-col items-center lg:flex-row gap-20 max-w-7xl m-auto">
          <div class="relative w-full md:w-1/2 lg:w-1/3 h-96">
          <div class="bg-gray-200 rounded-xl border-black border-2 transition-all w-full h-full overflow-hidden flex items-center justify-center" >
            {image && (
              <img src={image} alt={name} class="object-cover w-full h-full" transition:name={`picture_${slug}`}/>
            )}
            <!-- TODO use in the future <ImageGroup /> -->
          </div>
        </div>
        <div class="flex flex-col gap-4 flex-1">
          <div class="flex gap-4 items-center flex-wrap">
            <span class="text-5xl sm:text-7xl bold font-body font-bold" transition:name={slug || ""}>{name}</span>
            <CatTags cat={cat} />
          </div>
          <!-- TODO change to component and animate -->
          {social && playful && loving ? 
            <div class="flex gap-8 items-center">
              <div class="text-gray-500">
                <span class="">soci√°vel</span>
                <div class="text-xl">
                  <i class:list={["ph-duotone ph-cat", {"text-black !font-bold before:!text-blue before:!opacity-100": ["1", "2", "3"].includes(social) }]}/>
                  <i class:list={["ph-duotone ph-cat", {"text-black !font-bold before:!text-blue before:!opacity-100": ["2", "3"].includes(social) }]}/>
                  <i class:list={["ph-duotone ph-cat", {"text-black !font-bold before:!text-blue before:!opacity-100": ["3"].includes(social) }]}/>
                </div>
              </div>
              <div class="text-gray-500">
                <span>brincalh√£o</span>
                <div class="text-xl">
                  <i class:list={["ph-duotone ph-yarn", {"text-black !font-bold before:!text-yellow before:!opacity-100": ["1", "2", "3"].includes(playful) }]}/>
                  <i class:list={["ph-duotone ph-yarn", {"text-black !font-bold before:!text-yellow before:!opacity-100": ["2", "3"].includes(playful) }]}/>
                  <i class:list={["ph-duotone ph-yarn", {"text-black !font-bold before:!text-yellow before:!opacity-100": ["3"].includes(playful) }]}/>
                </div>
              </div>
              <div class="text-gray-500">
                <span>carente</span>
                <div class="text-xl">
                  <i class:list={["ph-duotone ph-heart", {"text-black !font-bold before:!text-pink before:!opacity-100": ["1", "2", "3"].includes(loving) }]}/>
                  <i class:list={["ph-duotone ph-heart", {"text-black !font-bold before:!text-pink before:!opacity-100": ["2", "3"].includes(loving) }]}/>
                  <i class:list={["ph-duotone ph-heart", {"text-black !font-bold before:!text-pink before:!opacity-100": ["3"].includes(loving) }]}/>
                </div>
              </div>
            </div> : <></>}
          {Boolean(birthDate) && <p>Nasci {bornAtTheShelter ? "no abrigo ": ""}{birthDateDistance} <small>({birthDate}).</small></p>}
          {Boolean(rescueDate && !bornAtTheShelter) && <p>Fui resgatad{article} {rescueDateDistance} <small>({rescueDate}).</small></p>}
          {Boolean(status) && <p>{status}.</p>}
          <!-- FIXME add small button size-->
          {patronized ? <p>Estou apardinhad{article}. üéâ</p> : <button class="font-body text-lg font-bold underline self-start">Me apadrinhe</button>}
          <p>{description}</p>
        </div>
      </div>
      <div class="max-w-7xl m-auto w-full">
        <AdoptForm startOpened={startOpened} client:visible />
      </div>
      <div class="flex flex-col gap-2">
        <h2 class="text-4xl font-body font-bold">Outros parecidos</h2>
        <CatsList cats={cats?.filter(cat => cat.slug !== slug)} client:visible />
      </div>
    </div>
  </div>
</Layout>
